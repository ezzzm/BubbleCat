---
// Live2D 看板娘最终解决方案组件
---
<script is:inline>
(async () => {
    // 确保此脚本只在客户端运行一次
    if (typeof window === 'undefined' || window.live2dWidgetLoaded) return;
    window.live2dWidgetLoaded = true;

    if (window.innerWidth < 768) return;

    const live2d_path = 'https://fastly.jsdelivr.net/npm/live2d-widgets@1.0.0-rc.7/dist/';
    
    function loadExternalResource(url, type) {
        return new Promise((resolve, reject) => {
            let tag;
            if (type === 'css') {
                tag = document.createElement('link');
                tag.rel = 'stylesheet';
                tag.href = url;
            } else if (type === 'js') {
                tag = document.createElement('script');
                tag.type = 'module';
                tag.src = url;
            }
            if (tag) {
                tag.onload = () => resolve(url);
                tag.onerror = () => reject(url);
                document.head.appendChild(tag);
            }
        });
    }

    const persistentContainer = document.createElement('div');
    persistentContainer.id = 'live2d-persistent-container';
    document.body.appendChild(persistentContainer);

    try {
        await Promise.all([
            loadExternalResource(live2d_path + 'waifu.css', 'css'),
            loadExternalResource(live2d_path + 'waifu-tips.js', 'js')
        ]);
    } catch (error) {
        console.error('Failed to load Live2D assets:', error);
        return;
    }

    if (window.initWidget) {
        window.initWidget({
            waifuParent: '#live2d-persistent-container',
            waifuPath: live2d_path + 'waifu-tips.json',
            cdnPath: 'https://fastly.jsdelivr.net/gh/fghrsh/live2d_api/',
            cubism2Path: 'https://cdn.jsdelivr.net/npm/live2d-widget@3.1.4/lib/live2d.min.js',
            tools: ['hitokoto', 'switch-model', 'photo', 'info', 'quit'],
        });

        // 用 CSS 覆盖的方式解决点击和层级问题
        const style = document.createElement('style');
        style.innerHTML = `
            #live2d-persistent-container, #waifu {
                z-index: 99999 !important;
                pointer-events: none !important;
            }
            #waifu-toggle, #waifu-tool *, #live2d {
                pointer-events: auto !important;
            }
        `;
        document.head.appendChild(style);
    }
})();
</script>